name: ci-helpers-rpm-build
on:
  workflow_call:
    inputs:
      runner:
        type: string
        default: ubuntu-latest
      working_directory:
        type: string
        default: "."
      fetch_depth:
        type: number
        default: 0
      prebuild_command:
        type: string
        default: ""
      spec_path:
        type: string
        default: ""
      extra_packages:
        type: string
        default: ""
      artifact_name:
        type: string
        default: "rpm-packages"
      artifact_glob:
        type: string
        default: "../*.rpm"

jobs:
  build:
    runs-on: ${{ inputs.runner }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: ${{ inputs.fetch_depth }}
          fetch-tags: true

      - name: Install packaging prerequisites
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            rpm
          if [ -n "${{ inputs.extra_packages }}" ]; then
            sudo apt-get install -y ${{ inputs.extra_packages }}
          fi

      - name: Build package
        shell: bash
        working-directory: ${{ inputs.working_directory }}
        run: |
          set -euo pipefail
          args=(--repo "${{ inputs.working_directory }}")
          if [ -n "${{ inputs.prebuild_command }}" ]; then
            args+=(--prebuild "${{ inputs.prebuild_command }}")
          fi
          if [ -n "${{ inputs.spec_path }}" ]; then
            args+=(--spec "${{ inputs.spec_path }}")
          fi
          ./vendor/script-helpers/scripts/build_rpm_artifacts.sh "${args[@]}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: ${{ inputs.artifact_glob }}
